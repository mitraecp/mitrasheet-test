import Ue from"./SpreadSheetDataHeader.4d4bfed5.js";import Xe from"./GCSpreadSheet.7722314b.js";import Ye from"./DroppableWrapper.e14af8ec.js";import Pe from"./SheetToDBMenu_.ff939604.js";import Ne from"./ViewMenu.7f1c5b0b.js";import He from"./MetadataMenu.b0f082e3.js";import{u as Oe}from"./drag.f5ca2003.js";import{u as ze}from"./useURLPaths.92126496.js";import{b as Le}from"./index.d52a6416.js";import{u as $e}from"./dimension_store.1aca34b5.js";import{u as K}from"./dataset_store.f318df7c.js";import{f as je,E as q,aS as Ke,ae as qe,Y as Ge,aY as Je,dK as Qe,al as D,r as h,H as G,s as _,b as Ze,e as J,u as r,c as A,J as C,l as Q,w as eo,A as oo,dL as to,aX as U,aj as ao,o as b}from"./entry.102678be.js";import{u as ro,a as io,g as Z,b as no}from"./useChartsSettings.971a22bb.js";import{u as so}from"./useHeadSettings.f1985dcc.js";import"./SpreadSheetDynamicMenu.1635bc55.js";import"./SpreadSheetEditDynamization.5561326d.js";import"./ProjectView.vue.c9650a78.js";/* empty css                         *//* empty css                    *//* empty css                             */import"./MitraButton.1bc6f00c.js";import"./legacy_store.afec42ea.js";import"./useLegacyService.c9b3bbf8.js";import"./HeaderBar.vue.02da9777.js";import"./members_store.a95d955a.js";import"./metadata_store.49c5a48c.js";/* empty css                                    *//* empty css                           */import"./MitraIconButton.142ef623.js";/* empty css                         *//* empty css                            *//* empty css                             */import"./regexp.6086e722.js";/* empty css                        *//* empty css                        */import"./composables.aec528df.js";import"./SpreadSheetDynamization.873b495d.js";import"./BaseContentHeader.0262d7f9.js";import"./BaseContentFooter.vue.20fdc5e7.js";import"./DropdownButton_.59b46351.js";import"./useViewService.062f2c04.js";import"./table_constants.06ca38ff.js";import"./SpreadSheetToolkit.f812d117.js";import"./TextColorIcon.vue.203e11e1.js";import"./SpreadSheetColorPicker.ed48fe8c.js";import"./ColorPicker.vue.dc2b6224.js";import"./FillColorIcon.vue.bd27683d.js";import"./SheetToDBRegister_.bde00d7c.js";import"./MetadataAddButton.41902bb4.js";import"./SheetToDBAddRegister_.be23964f.js";import"./AddDimensionAutocomplete.4607c47e.js";import"./AddAttributesOfDimensionAutocomplete.0057a0b5.js";import"./useDataTypeIcons.d26d6eae.js";import"./MButton.vue.eb72e6c7.js";import"./SheetToDBAxisX_.03e1d7f0.js";import"./SheetToDBCube_.757b9d67.js";import"./SheetToDBAddCube_.f1fa7175.js";import"./AddCubeAutocomplete.6aa2d88e.js";import"./MetadataButton.vue.350ca6ce.js";import"./SimpleAccordion.72c52608.js";import"./ViewYAxis.vue.f224b60d.js";import"./ViewDimensionSelector.7211b5bd.js";import"./ViewXAxis.vue.25f97c49.js";import"./ViewFilter.vue.d756c6e1.js";import"./ViewFilterSelector.76e5ee38.js";import"./ViewMeasureForm.vue.30497a93.js";import"./ViewDatasetSelector.d6ec789c.js";import"./DatasetEditor.vue.7d311014.js";import"./useFormRules.a113b67d.js";import"./DimensionList.vue.eb7d2f91.js";import"./AccordionListMenu.10ceb037.js";import"./useGoToScreen.2d5a4740.js";import"./DatasetList.vue.42e42433.js";import"./index.3105222b.js";const lo={class:"flex bg-white overflow-hidden h-full w-full"},mo={class:"flex flex-col w-full overflow-hidden"},uo={class:"flex h-full overflow-hidden"},Mt=je({__name:"index",setup(co){const{inDragging:ee,dragPositionX:oe,dragPositionY:te}=Oe();q(async()=>{const{sheetId:e}=ze();e&&await H(e)});const{b:ae,command:re,u:ie,i:ne,ctrl:se,current:de}=Le();Ke(()=>{var e;(se.value||re.value)&&(ae.value||ie.value||ne.value)&&((e=n.value)==null||e.applyKeyShortcut(de))});const le=$e(),me=K(),c=qe(),ue=Ge(),ce=Je(),l=ro(),fe=io(),pe=Qe(),{activeSheetRef:X}=D(c),{readonlyProject:B}=D(ue),{viewForm:v}=D(l),{sheetToDBForm:we}=D(pe),{getDataViewMode:he,isPreview:M}=D(ce),x=h(),n=h(),Y=h(!1),g=G(()=>c.getWorkbookSheetAsTabs(X.value.workbookId));l.resetViewForm();const{fetchWorksheetByIndex:S,addWorksheet:ge,getWorkbook:ve}=to();function ke(e){l.setViewForm(e)}function ye(){U().switchDialog("menuDatabase",!1)}function m(e){var t,a;l.verifyViewFormIsValid()&&((t=n.value)==null||t.viewIntoSheet(e));const o=(a=l.viewForm.indexOfChart)!=null?a:-1;l.viewForm.isChartView&&o!==-1&&fe.changeChartDataViewByIndex(o)}function R(e){var o;U().switchDialog("menuDatabase",e===void 0?!U().menuDatabase:e),(o=n.value)==null||o.refreshSheetUI()}function De(e){var o;(o=n.value)==null||o.setHeadersAndContentOfRange(e)}function be(e){var o;(o=n.value)==null||o.setDynamicSelectionByRange(e)}function P(e){var o;(o=n.value)!=null&&o.verifyRangeIsValid(e)?(x.value={range:{isValid:!0}},m()):x.value={range:{isValid:!1,message:ao.global.t("SHEET.RANGE.invalid_range")}}}function xe(e){var o;(o=n.value)==null||o.clearBordersByRange(e)}function E(e){var o;xe(e),(o=n.value)==null||o.removeTagsOfRange(e)}function Se(e){var t;const o={range:"A1",isView:!0,isChartView:!0,axisY:[],axisX:void 0,viewMeasureForm:[]};l.setViewForm(o),(t=n.value)==null||t.createFloatingObjectInActiveSheet(e)}const u=h(),Ie=h(0),p=h(!1),W=G(()=>{var e,o,t;return(e=u.value)!=null&&e.isDataset?"dataset":(o=u.value)!=null&&o.isDimension?"dimension":((t=u.value)!=null&&t.isView,"view")});q(()=>{K().cleanDatasetDraftRefs(),Ve()});function w(){var e,o;l.viewFormClone.id||E((e=l.viewFormClone.range)!=null?e:""),(o=n.value)==null||o.clearBordersByRange(),u.value=void 0,l.resetViewForm()}function Ve(){le.fetchTreeDimensions(),me.fetchTreeDatasets()}function Te(e){u.value=e}function Fe(e){u.value&&("isDataset"in u.value||"isDimension"in u.value)&&(u.value.name=e.name)}const I=h(!1),_e=()=>{I.value=!0};function Ae(){I.value=!1}const Ce=e=>{var o;if(e.dataTransfer){const t=JSON.parse(e.dataTransfer.getData("value")).data;if(I.value=!1,t.isDimension){w();const a=t.id;m({byDragAndDrop:!0,dropPosition:{x:e.offsetX,y:e.offsetY},dataToAddInViewFormated:a,dataType:"dimension"})}else if(t.isDataset){alert("N\xE3o \xE9 poss\xEDvel adicionar um dataset"),w();const a={showAll:!1,axisX:void 0,name:t.name,chips:[{aggregator:"SUM",metricId:1}]};m({byDragAndDrop:!0,dropPosition:{x:e.offsetX,y:e.offsetY},dataToAddInViewFormated:a,dataType:"metric"})}else if("metricName"in t){const a={showAll:!1,axisX:void 0,name:t.metricName,chips:[{aggregator:"SUM",metricId:t.id}]};m({byDragAndDrop:!0,dropPosition:{x:e.offsetX,y:e.offsetY},dataToAddInViewFormated:a,dataType:"metric"})}else if("dimensionId"in t){if(!(((o=l.viewForm.axisY)==null?void 0:o.every(s=>s!==t.dimensionId))&&t.dimensionId!==l.viewForm.axisX)){_("N\xE3o \xE9 poss\xEDvel adicionar a mesma dimens\xE3o");return}const i=t.dimensionId;m({byDragAndDrop:!0,dropPosition:{x:e.offsetX,y:e.offsetY},dataToAddInViewFormated:i,dataType:"dimension"})}else if("datasetDimensionViews"in t){const a={showAll:!1,axisX:void 0,name:t.name,chips:[{aggregator:"SUM",metricId:t.datasetDimensionViews[0].metricId}]};m({byDragAndDrop:!0,dropPosition:{x:e.offsetX,y:e.offsetY},dataToAddInViewFormated:a,dataType:"metric"})}else if("dimensionAttributeType"in t){if(t.dimensionAttributeType!=="MultiLinkDimension"&&t.dimensionAttributeType!=="SingleLinkDimension"){const i={showAll:!1,axisX:void 0,name:t.name,chips:[{aggregator:"SUM",attributeId:t.id}]};m({byDragAndDrop:!0,dropPosition:{x:e.offsetX,y:e.offsetY},dataToAddInViewFormated:i,dataType:"metric"})}else{const i=t.referencedDimensionId;m({byDragAndDrop:!0,dropPosition:{x:e.offsetX,y:e.offsetY},dataToAddInViewFormated:i,dataType:"dimension"})}const a={showAll:!1,axisX:void 0,name:t.name,chips:[{aggregator:"SUM",metricId:t.datasetDimensionViews[0].metricId}]};m({byDragAndDrop:!0,dropPosition:{x:e.offsetX,y:e.offsetY},dataToAddInViewFormated:a,dataType:"metric"})}}};function N(e){Ie.value=e}async function Be(){var o;const e=c.getActiveWorkbookId();if(e){Y.value=!0;const{sheetTab:t,error:a}=await ge({workbookId:e,name:""});if(a)_("Falha ao adicionar P\xE1gina");else{const{data:i,error:s}=await S({workbookId:e,worksheetIndex:t.index,viewFilterForm:{filterItems:[]}});if(!s){c.addSheetTab(e,t),(o=n.value)==null||o.addNewSheet(i.worksheet,i.worksheetIndex);const d=g.value.findIndex(f=>f.index===t.index);d>-1&&N(d)}}Y.value=!1}}async function H(e){var o;if(!p.value){p.value=!0;try{const{data:t,error:a}=await ve(e),i=Z(),{data:s,error:d}=await S({workbookId:t.workbookId,worksheetIndex:t.worksheetIndex,viewFilterForm:{filterItems:i}});if(i.length||no(s),t.workbook.sheets={[t.sheetNames[0].name]:s.worksheet},a||d)throw new Error("Falha ao carregar xlsx.");Me({...t,dynamizations:(o=s.dynamizations)!=null?o:[]})}catch{_("Falha ao carregar xlsx.")}p.value=!1}}async function O(){if(!p.value){p.value=!0;try{const e=c.getWorkbookDinamization();l.setDynamizationFilterForm(e),await z({buildSheetTab:!1,sheetIdx:c.activeSheetIndex,viewFilterForm:{filterItems:e}})}catch{_("Falha ao carregar xlsx.")}p.value=!1}}function Me(e){var a,i;const{sheetNames:o,workbookId:t}=e;o&&t&&(c.buildWorkbookMetadata(e),N(0),(a=n.value)==null||a.buildWorkbook(e.workbook,e.worksheetIndex),so().setHeadTitle((i=c.activeSheetRef.name)!=null?i:""))}async function Re(e){var a,i;const o=c.getActiveWorkbookId();if(!o)throw new Error("Workbook id is not defined");const t=Z();for(let s=0;s<e.length;s++){const{data:d,sendedSheetIdx:f,error:V}=await S({workbookId:o,worksheetIndex:e[s],viewFilterForm:{filterItems:t}});if(V)We({idx:f,needsReload:!0});else{const k=g.value.findIndex(T=>T.index===(d==null?void 0:d.worksheetIndex));(a=n.value)==null||a.clearSheetNeedsReload(k),d.worksheet&&k>-1&&((i=n.value)==null||i.reloadSheetData(d.worksheet,d.worksheetIndex))}Ee(e[s])}}function Ee(e){var o;(o=n.value)==null||o.loadBDChartToTheSheet(e)}async function z({buildSheetTab:e,viewFilterForm:o,sheetIdx:t}){var i,s,d;const a=(i=g.value.find(f=>f.index===t))==null?void 0:i.index;if(a!==void 0){const{data:f}=await S({workbookId:c.getActiveWorkbookId(),worksheetIndex:a,viewFilterForm:o!=null?o:{filterItems:[]}});e?(s=n.value)==null||s.buildSheet(f.worksheet,t):(d=n.value)==null||d.reloadSheetData(f.worksheet,t)}}function We({idx:e,needsReload:o}){const t=g.value.findIndex(i=>i.index===e),a=g.value[t];return a.needsReload=o!=null?o:!1,t}return(e,o)=>{var V,k,T,L,$,j;const t=Ue,a=Xe,i=Ye,s=Pe,d=Ne,f=He;return b(),Ze("div",lo,[J("div",mo,[r(n)&&!e.$withoutHeader()?(b(),A(t,{key:0,readonly:r(B)||r(M),onUpdate:O,onToggleDatabaseMode:R},null,8,["readonly"])):C("",!0),J("div",uo,[Q(i,oo({onDragOver:_e,onDragLeave:Ae,onDrop:Ce},{class:"overflow-hidden bg-white"}),{default:eo(()=>[Q(a,{ref_key:"sheetRef",ref:n,"drag-position-x":r(oe),"drag-position-y":r(te),"is-over-drop-zone":r(I),readonly:r(B)||r(M),"is-grid":e.$withoutHeader(),"sheet-tabs":r(g),"workbook-id":r(X).workbookId,onUpdateSheets:Re,onSheetLoaded:z,onSetViewForm:ke,onSheetAdded:Be,onClearViewMenu:o[0]||(o[0]=F=>{u.value=void 0,w()}),onToggleDatabaseMode:R,onCloseDrawer:ye,onCreateChart:Se},null,8,["drag-position-x","drag-position-y","is-over-drop-zone","readonly","is-grid","sheet-tabs","workbook-id"])]),_:1},16),(V=r(we))!=null&&V.range?(b(),A(s,{key:0,"table-type":r(W),"view-chart-menu":!!((k=r(v))!=null&&k.range)&&((T=r(v))==null?void 0:T.isChartView),"validation-view-form":r(x),onCloseView:w,onUpdateView:o[1]||(o[1]=F=>{u.value=void 0,w()}),onViewMenuChange:o[2]||(o[2]=F=>{var y;return(y=r(n))==null?void 0:y.refreshSheetUI()}),onTriggerUpdateView:m,onBlockChanged:m,onClearBordersByRange:E,onVerifyRangeIsValid:P,onSetHeaderAndContentOfRange:De,onUpdateWorkbook:O,onSetDynamicSelectionByRange:be},null,8,["table-type","view-chart-menu","validation-view-form"])):C("",!0),r(he)==="SHEET"&&((L=r(v))==null?void 0:L.range)?(b(),A(d,{key:1,"table-type":r(W),"view-chart-menu":!!(($=r(v))!=null&&$.range)&&((j=r(v))==null?void 0:j.isChartView),"validation-view-form":r(x),onCloseView:w,onUpdateView:o[3]||(o[3]=F=>{u.value=void 0,w()}),onViewMenuChange:o[4]||(o[4]=F=>{var y;return(y=r(n))==null?void 0:y.refreshSheetUI()}),onTriggerUpdateView:m,onBlockChanged:m,onClearBordersByRange:E,onVerifyRangeIsValid:P},null,8,["table-type","view-chart-menu","validation-view-form"])):C("",!0),!r(B)&&!r(M)?(b(),A(f,{key:2,"table-type":r(W),"loading-sheet":r(p),onSelectedData:Te,onUpdateView:Fe,onLoadSheet:H,onInDragging:r(ee),onCloseDrawer:R},null,8,["table-type","loading-sheet","onInDragging"])):C("",!0)])])])}}});export{Mt as default};
