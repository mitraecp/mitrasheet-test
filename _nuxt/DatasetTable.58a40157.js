import{f as Ke,j as Qe,r as v,H as me,aB as G,b as _,m as pe,t as T,l as g,u as a,J as P,c as j,w as $,an as Xe,ax as ae,C as Ye,aC as oe,s as se,x as Ze,v as ve,o as D,ah as et,e as w,aD as tt,ay as ye,au as nt,av as at,y as ot,z as st,a as it}from"./entry.102678be.js";import lt from"./TableAttributeContextMenu.c1ad8a44.js";import{_ as rt}from"./TableDynamicCell.vue.a471fd36.js";import dt from"./TableLinkRecord.6de8f04c.js";import{_ as ct}from"./MButton.vue.eb72e6c7.js";/* empty css                    */import{u as ut}from"./useDataTypeIcons.d26d6eae.js";import{b as ft,c as mt,u as pt}from"./useLegacyService.c9b3bbf8.js";import{u as vt}from"./dataset_store.f318df7c.js";import{u as yt,a as Dt}from"./useAttributeTypes.0411c883.js";import{u as ht}from"./index.d52a6416.js";import{u as It}from"./DataEntry.class.85823036.js";import bt from"./SmartSheet.02ade0c8.js";import Ct from"./DatabaseSmartSheet.a9157bcb.js";import _t from"./TableAttributeMenu.3f27ab4e.js";import{T as De}from"./table_constants.06ca38ff.js";/* empty css                           */import"./TableCheckbox.vue.071e61a3.js";import"./TableDatePicker.vue.a1333c1a.js";import"./TableAutoComplete.d2339888.js";import"./index.3105222b.js";import"./CollaboratorAvatar.vue.dd08577c.js";import"./dimension_store.1aca34b5.js";import"./TableComponentsMenu.b916b5cb.js";import"./useFormRules.a113b67d.js";function gt(){return parseInt(`${Math.random()+new Date().getTime()}`)}const wt=M=>(ot("data-v-2b8cf916"),M=M(),st(),M),xt={key:0,class:"mb-5 font-bold flex justify-between items-center mx-2 ml-3"},At={key:1,class:"w-full h-full bg-grey-300 absolute z-20"},St=wt(()=>w("div",{class:"bg-grey-200 h-full w-full animate-pulse"},null,-1)),Tt=[St],Mt=["title"],kt={class:"flex items-center justify-center mr-[6px]"},Nt={class:"truncate"},Lt={key:0,class:"flex flex-col justify-center ml-auto"},$t=["title","onClick"],Et=["onClick"],Vt={key:1,class:"px-2"},Rt={key:1,class:"flex items-end cursor-pointer h-full"},Ft={key:2,class:"flex items-end font-sans hover:cursor-pointer"},Bt=["onClick"],Ot=["title"],Pt={class:"title"},jt={class:"att-title"},Wt={class:"table-att-menu flex items-center button-panel"},zt=Ke({__name:"DatasetTable",props:{loadOnCreated:{type:Boolean,default:!1},dataset:{type:Object,required:!0},displayName:{type:Boolean,default:!0},fixed:{type:Number,default:0}},emits:["update-view"],setup(M,{expose:he,emit:Ie}){const p=M,be=p.fixed?Ct:bt,Ce=ut(),{merge:k}=Qe(),E=ft(),x=vt();x.cleanDatasetDraftRefs();const{linkRecordSaving:B}=yt(),q=!0,h=v([]),J=v(Array([])),s=v([]),K=v(G.SIMPLE_ROW_LIMIT),_e=me(()=>k?s.value.slice(0,K.value):s.value);let Q=[];const W=v(null),ge=v(),N=v(!1),V=v(!1),ie=v(-1),O=v(0),R=v(!1),z=v(!1),F=v(!1),X=v(!1),Y=v("-"),{datasetMetricTypeList:we,metricTypeListAsOptions:xe}=Dt(),H=v(!0),L=v({id:0,name:"",isNative:!1,dimensionAttributeType:"SingleLineText",options:[]});p.loadOnCreated&&te({datasetId:p.dataset.id,displayLoadingFrame:!0}),ht(document,"keydown",e=>{e.ctrlKey&&(e.key==="c"&&ze(),e.key==="v"&&je())});const A=me(()=>h.value.concat({id:0,name:"+",isNative:!1,dimensionAttributeType:"Number",options:[]}));function Ae(){const e={};e.datasetDimensionContentViews=Array(h.value.length).fill(null),e.metricContentViews=[],e.draftId=`draft-${gt()}`,s.value.push(e),setTimeout(()=>{var t;return(t=W.value)==null?void 0:t.focusCell(s.value.length-1,0)})}function Se(e){Te(e)}async function Te(e){var l;const{data:t,error:n}=await mt().addDatasetMetric({datasetId:p.dataset.id,type:e.dimensionAttributeType,name:e.name,options:e.options},Q);n?se((l=n.message)!=null?l:"DIMENSIONS.attributes.add_attribute_error"):(Z(!1),de(!1),s.value.forEach(r=>r.datasetDimensionContentViews.push(null)),J.value.push(De.COL_WIDTH),h.value.push(t),x.fetchDatasets())}async function Me(e,t,n){B.value=!0;const l=k?t:s.value[t].internalId,r=A.value[n].id;if(l===void 0)U({[`${t}-${n}`]:{metricId:r,metricValue:e}});else{const y=[{datasetDimensionContentForms:[],internalId:l,metricContentForms:[{metricId:r,metricValue:e}]}];s.value[t].datasetDimensionContentViews[n]={metricId:r,metricValue:e},await le(y),B.value=!1}}async function U(e){var r,y,I,C,b,i,c;const t={};for(const d in e){const f=d.split("-");if(f.length===2){const m=Number(f[0]),o=Number(f[1]),u=e[d];s.value[m].datasetDimensionContentViews[o]=oe(u);const S=(y=(r=s.value[m].draftId)!=null?r:k?d:s.value[m].internalId)!=null?y:"",ne=(I=u==null?void 0:u.metricValue)!=null?I:u;if(t[S]||(t[S]={internalId:S,datasetDimensionContentForms:[],metricContentForms:[]}),"metricName"in h.value[o])t[S].metricContentForms.push({metricId:h.value[o].id,metricValue:ne});else{const Je=(i=(b=u==null?void 0:u.id)!=null?b:(C=u==null?void 0:u.value)==null?void 0:C.dimensionContentInternalId)!=null?i:u;t[S].datasetDimensionContentForms.push({datasetDimensionId:h.value[o].id,dimensionData:{dimensionId:(c=h.value[o].dimensionId)!=null?c:0,dimensionContentInternalId:Je}})}}}const n=[];for(const d in t)if(d.includes("draft-")){const m=s.value.findIndex(u=>u.draftId===d),o=oe(s.value[m]);m>-1&&x.writeDraft(oe(t[d]),{datasetId:p.dataset.id,key:d,line:o,dimensionsAmount:h.value.filter(u=>"dimensionId"in u).length})}else n.push(t[d]);const l=x.getFullFilledDrafts(p.dataset.id);if(l.length){re(l);const{content:d,error:f}=await E.saveDatasetContent({datasetId:p.dataset.id,datasetContentForms:l.map(m=>{const{internalId:o,...u}=m;return u})});if(f){se(f.message),x.cleanDatasetDraftRefs();for(const m in e){const o=m.split("-");if(o.length===2){const u=Number(o[0]);s.value.splice(u,1)}}}else{const{internalIds:m}=d;x.cleanDraftsByDatasetId(p.dataset.id,l.map(o=>`${o.internalId}`)),l.forEach((o,u)=>{O.value+=1;const S=s.value.findIndex(ne=>ne.draftId===o.internalId);s.value[S].internalId=m[u],delete s.value[S].draftId})}}if(n.length){const d=n==null?void 0:n.map(f=>({...f,datasetDimensionContentForms:[]})).filter(f=>f.metricContentForms.length);d.length&&le(d)}B.value=!1}async function le(e){try{re(e);const{error:t,deletedLines:n}=await E[k?"saveDatasetContent":"putDatasetContent"]({datasetId:p.dataset.id,datasetContentForms:e});t||n.forEach(l=>{const r=s.value.findIndex(y=>y.internalId===l);r>=0&&s.value.splice(r,1)})}catch{}}function re(e){k&&e.forEach(t=>{var r,y;const n=t.internalId,l=[];(y=(r=s.value.find((I,C)=>`${n}`.includes("draft-")?I.draftId===n:C===parseInt(`${t.internalId}`.split("-")[0])))==null?void 0:r.datasetDimensionContentViews)==null||y.forEach((I,C)=>{var i;const b=Number(h.value[C].dimensionId);Q.includes(b)&&l.push({datasetDimensionId:b,dimensionData:{dimensionContentInternalId:(i=I.id)!=null?i:I.value.dimensionContentInternalId,dimensionId:b}})}),t.datasetDimensionContentForms=l,delete t.internalId})}function ke(){return h.value.filter(e=>"metricName"in e).length===1}function Ne(e){de(!0),L.value=e}function Z(e){N.value=e}function de(e){H.value=e}function ee(e,t){e.dimensionId||(ie.value=t,e.id||(e.name=""),L.value=e,H.value=!!e.id,Z(!0))}function Le(e){return e===null||typeof e=="boolean"?e:"metricValue"in e?e.metricValue:e}async function $e(e){const t=s.value[e].internalId;if(t){const{error:n}=await(k?pt().deleteDatasetRow(Ee(e)):E.deleteDatasetRow(p.dataset.id,+t));R.value=!1,n||(s.value.splice(e,1),O.value=s.value.length)}}function Ee(e){const t=s.value[e];return{datasetId:p.dataset.id,datasetContentForms:{datasetDimensionContentForms:t.datasetDimensionContentViews.map(n=>n.value?{datasetDimensionId:n.datasetDimensionId,dimensionData:{dimensionContentInternalId:n.value.dimensionContentInternalId,dimensionId:n.datasetDimensionId}}:void 0).filter(n=>n),metricContentForms:t.metricContentViews.map(n=>({...n,metricId:Number(n.metricId)}))}}}function Ve(e){Y.value=typeof e=="string"?e:"-"}function Re(e){Y.value=e,R.value=!0}async function Fe(){if(k)K.value=K.value+G.SIMPLE_ROW_LIMIT;else{let e=[];if(ue(s.value.length))e=ce(p.dataset.id),s.value=[...s.value,...e];else{const{datasetDataView:t}=await E.getDatasetContent(p.dataset.id,{query:{limit:G.SIMPLE_ROW_LIMIT,offSet:s.value.length}});fe(t),s.value=[...s.value,...t.contents]}}}function ce(e){const t=[],n=x.getDatasetDraft(e);if(n)for(const l in n)s.value.findIndex(y=>y.draftId===n[l].lineView.draftId)<0&&t.push(n[l].lineView);return t.reverse()}async function te({displayLoadingFrame:e,datasetId:t}){e&&(z.value=!0);const{datasetDataView:n,rowCount:l}=await E.getDatasetContent(t!=null?t:p.dataset.id,{query:{limit:G.SIMPLE_ROW_LIMIT,offSet:0}});O.value=l;let r=[];ue(n.contents.length)&&(r=ce(p.dataset.id)),Pe(n),fe(n),Oe(),s.value=[...n.contents,...r],z.value=!1}function ue(e){return O.value-e<=0}function Be(e,t){const n=A.value[t].dataType==="Number";return e===null?e:typeof e=="object"&&"metricValue"in e&&n?e.metricValue===null?e.metricValue:Number(e.metricValue).toFixed(2):n&&typeof e=="number"?Number(e).toFixed(2):typeof e=="object"?e.metricValue:e}function Oe(){J.value=Array(h.value.length).fill(De.COL_WIDTH)}function Pe(e){Q=e.headers.datasetDimensionViews.map(t=>t.dimensionId),h.value=[...e.headers.datasetDimensionViews,...e.headers.metricViews]}function fe(e){e.contents.forEach(t=>{t.datasetDimensionContentViews.push(...t.metricContentViews)})}function je(){var t;const e=(t=W.value)==null?void 0:t.getActiveCell();navigator.clipboard.readText().then(n=>{const l=n.split(`\r
`).map(I=>I.split("	")),r={};let y=0;if(e&&e.rowStart&&e.colStart){const I=e.rowStart+l.length-1,C=e.colStart+l[0].length-1;for(let b=e.rowStart;b<=I;b++){let i=0;if(!s.value[b])break;for(let c=e.colStart;c<=C;c++){const d=A.value[c];if(!d)break;const f=d.dimensionAttributeType;if(f==="Number"||f==="SingleLineText"){const m=l[y][i],o=f==="Number"?Number(m):m;(o||o===0)&&(r[`${b}-${c}`]=o)}i++}y++}U(r)}})}function We(e,t,n){s.value[n].datasetDimensionContentViews[t]=e,U({[`${n}-${t}`]:e})}function ze(){var t;const e=(t=W.value)==null?void 0:t.getActiveCell();if(e&&e.rowAnd&&e.rowStart&&e.colAnd&&e.colStart){let n="";for(let l=e.rowStart;l<=e.rowAnd;l++){for(let r=e.colStart;r<=e.colAnd;r++)n=n+s.value[l].datasetDimensionContentViews[r],r!==e.colAnd&&(n=n+"	");l!==e.rowAnd&&(n=n+`\r
`)}navigator.clipboard.writeText(n)}}function He(e){({openDeleteMetricModal:Ue,openMetricEditModal:Ge})[e]()}function Ue(){Z(!1),F.value=!0}function Ge(){}async function qe(){var e;X.value=!0;try{const{error:t}=await E.deleteDatasetMetric({metricId:L.value.id,datasetId:p.dataset.id});if(!t)F.value=!1,te({displayLoadingFrame:!1}),x.fetchDatasets();else throw t}catch(t){se((e=t.message)!=null?e:"DIMENSIONS.attributes.delete_attribute_error")}X.value=!1}return he({loadDatasetContent:te}),(e,t)=>{const n=Ze,l=lt,r=ve("a-popover"),y=rt,I=dt,C=ct,b=ve("a-modal");return D(),_("div",{class:Ye(["bg-white flex flex-col overflow-hidden w-full relative dataset-table",{"p-2":!a(z)}])},[p.displayName?(D(),_("div",xt,[pe(T(p.dataset.name)+" ",1),g(n,{class:"cursor-pointer",color:"grey",type:"mdi",size:"18",path:a(et),onClick:t[0]||(t[0]=i=>Ie("update-view",i))},null,8,["path"])])):P("",!0),a(z)?(D(),_("div",At,Tt)):P("",!0),(D(),j(Xe(a(be)),{ref_key:"supersheet",ref:W,items:a(_e),"col-widths":a(J),"nested-headers":a(A),"add-column":q,"data-key-name":{contentViews:"datasetDimensionContentViews",contentType:"dataType"},fixed:M.fixed,"row-count":a(O),"row-height":32,"add-line":"","has-draft-alert":"",onAddRow:Ae,onDataEntry:U,onContextMenu:Re,onContextHeader:t[7]||(t[7]=i=>ee(i.item,i.idx)),onLoadData:Fe},{header:$(({item:i,col:c})=>{var d,f,m;return[q&&c!==a(h).length||!q?(D(),_("div",{key:0,title:(f=(d=i.alias)!=null?d:i.dimensionName)!=null?f:i.metricName,class:"root flex items-center width-fill-available header mx-[10px]"},[w("div",kt,[g(n,{color:"var(--grey-600)",type:"mdi",height:"15px",path:i.dataType&&a(Ce)[i.dataType]},null,8,["path"])]),w("div",Nt,T(((m=i.alias)!=null?m:i.dimensionName)||i.metricName),1),i.isNative?P("",!0):(D(),_("div",Lt,[g(n,{class:"cursor-pointer ml-[6px]",color:"#8D95B3",type:"mdi",size:"18",path:a(tt),onClick:o=>ee(i,c)},null,8,["path","onClick"])]))],8,Mt)):(D(),_("div",{key:1,class:"root flex max-w-[80px] min-w-[80px] items-center justify-center font-sans hover:cursor-pointer","data-cy":"btn-add-column",title:e.$t("DATABASE.add_column"),onClick:o=>ee(i,c)},[g(n,{size:"16",color:"#313854",type:"mdi",path:a(ye)},null,8,["path"])],8,$t)),(a(N)||a(V))&&a(ie)===c?(D(),j(r,{key:2,visible:a(N),"onUpdate:visible":t[4]||(t[4]=o=>ae(N)?N.value=o:null),"overlay-class-name":a(L).id&&!a(V)?"w-[130px]":"w-[350px]",placement:c<3?"bottomLeft":"bottomRight",trigger:"click","arrow-point-at-center":"",onVisibleChange:t[5]||(t[5]=o=>V.value=!1)},{content:$(()=>[a(L).id&&!a(V)?(D(),j(l,{key:0,options:[{title:e.$t("GLOBAL.edit"),icon:a(nt),action:"openMetricEditModal",disabled:!0},{title:e.$t("GLOBAL.delete"),icon:a(at),action:"openDeleteMetricModal",disabled:ke()}],onSelected:He},null,8,["options"])):(D(),j(_t,{ref_key:"editAttributeMenuRef",ref:ge,key:a(L).dimensionAttributeType,controller:a(H),"col-attributes":a(L),"type-options":a(xe),"dataset-id":M.dataset.id,types:a(we),onAddAttribute:t[1]||(t[1]=o=>(Se(o),N.value=!1)),onAddCol:Ne,onOnClose:t[2]||(t[2]=o=>a(V)?V.value=!1:N.value=!1),onOnBack:t[3]||(t[3]=o=>H.value=!1)},null,8,["controller","col-attributes","type-options","dataset-id","types"]))]),_:2},1032,["visible","overlay-class-name","placement"])):P("",!0)]}),default:$(({item:i,col:c,row:d})=>{var f,m;return["metricName"in a(A)[c]?(D(),_("div",{key:0,onClick:o=>Ve(`${d}-${c}`)},[a(It)()[(f=a(A)[c].dataType)!=null?f:""]?(D(),_("span",Vt,T(Be(i,c)),1)):(D(),j(y,{key:0,content:Le(i),header:a(A)[c],saving:a(B),onSetDataEntry:o=>Me(o,d,c)},null,8,["content","header","saving","onSetDataEntry"]))],8,Et)):(D(),_("div",Rt,[g(I,{content:(m=i==null?void 0:i.value)!=null?m:i,header:a(A)[c],"display-picture":!1,saving:a(B),"readonly-cell":!!a(s)[d].internalId,onSetDataEntry:o=>We(o,c,d)},null,8,["content","header","saving","readonly-cell","onSetDataEntry"])])),a(R)&&`${d}-${c}`===a(Y)?(D(),_("div",Ft,[g(r,{visible:a(R),"onUpdate:visible":t[6]||(t[6]=o=>ae(R)?R.value=o:null),"overlay-class-name":"w-[100px]",trigger:"click",placement:"bottomLeft"},{content:$(()=>[w("div",{class:"cursor-pointer hover:bg-[#eaecf0]",onClick:o=>$e(d)},T(e.$t("GLOBAL.delete")),9,Bt)]),_:2},1032,["visible"])])):P("",!0)]}),footer:$(()=>[w("div",{class:"flex items-center justify-center hover:cursor-pointer pl-[10px]","data-cy":"btn-add-row",title:e.$t("DATABASE.add_row")},[g(n,{size:"16",color:"#313854",type:"mdi",path:a(ye)},null,8,["path"])],8,Ot)]),_:1},40,["items","col-widths","nested-headers","fixed","row-count"])),g(b,{visible:a(F),"onUpdate:visible":t[9]||(t[9]=i=>ae(F)?F.value=i:null),"destroy-on-close":"",centered:"",closable:!1,footer:null},{default:$(()=>[w("div",Pt,T(e.$t("DATABASE.sure_to_delete_attribute")),1),w("div",jt,T(e.$t("DATABASE.action_cannot_undone")),1),w("div",Wt,[w("div",{class:"cancel cursor-pointer",onClick:t[8]||(t[8]=i=>F.value=!1)},T(e.$t("BUTTONS.cancel")),1),g(C,{loading:a(X),style:{"background-color":"#7839ee",color:"#fff"},class:"!w-[61px] !h-[33px] flex justify-center items-center","data-cy":"btn-submit",onClick:qe},{default:$(()=>[pe(T(e.$t("GLOBAL.delete")),1)]),_:1},8,["loading"])])]),_:1},8,["visible"])],2)}}}),Dn=it(zt,[["__scopeId","data-v-2b8cf916"]]);export{Dn as default};
